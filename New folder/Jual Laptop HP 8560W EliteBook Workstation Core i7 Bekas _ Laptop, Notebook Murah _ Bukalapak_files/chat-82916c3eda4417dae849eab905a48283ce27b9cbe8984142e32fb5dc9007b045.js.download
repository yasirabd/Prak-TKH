(function(){!function(e){var t;return t=function(){return this},t.prototype=e.extend(t.prototype,{getInfoDeferred:function(t){var n;return n=e.Deferred(),e.get("/users/"+t.join(",")+"/info.json").done(function(e){return n.resolve(e)}),n.promise()},timestampToDateInteger:function(e){var t;return t=new Date(e/1e3),Date.parse(t.toLocaleDateString("en-US"))},timestampToDateString:function(e){var t,n,a,o,r,i;return a=new Date(e/1e3),o=DAYS[a.getDay()],t=a.getDate(),r=MONTHS[a.getMonth()],i=a.getFullYear(),n=o+", "+t+" "+r+" "+i}}),("undefined"!=typeof exports&&null!==exports?exports:this).ChatBase=t}(jQuery)}).call(this),function(){!function(e){var t;return t=function(){return this},t.prototype=e.extend(ChatBase.prototype,{chatItemsSelector:".chat-room-items",chatItemSelector:".chat-room-item",chatItemDateSelector:".chat-room-item-date",addDateSeparator:function(t,n,a){var o,r,i;return r=this.timestampToDateInteger(n),i=this.timestampToDateString(n),o=t.find(this.chatItemDateSelector).filter(function(t){return e(this).data("dateInteger")===r}),o.length||(o=e("<div/>",{"class":"chat-room-item-date",html:"<span class='chat-room-item-date__text'>"+i+"</span>"}).data("dateInteger",r)),a?t.prepend(o):t.find(this.chatItemSelector).last().before(o)},getChatRoom:function(t){return e("#chat-room-overflow-"+t+", #chat-room-"+t)},addMessage:function(t,n,a,o){var r,i,s,l,c,u,d,m;i=t.find(this.chatItemsSelector),r=e("<div/>",{"class":"chat-room-item "+(o&&o.chatRoomItemClass?o.chatRoomItemClass:"")}),l=e("<div/>",{"class":"chat-room-item__image"}),s=e("<img/>",{"class":"chat-room-item__image__avatar",src:a}),m=e("<div/>",{"class":"chat-room-item__message"}),c=e("<div/>",{"class":"chat-room-item__message__body"}),u=e("<p/>",{html:n}),d=e("<div/>",{"class":"chat-room-item__message__time",html:(new Date).toLocaleTimeString("en-US",{hour12:!1}).substring(0,5)+" WIB"}),this.addDateSeparator(i,1e3*Date.now(),!1),l.append(s),c.append(u),m.append(c,d),r.append(l,m),i.find(this.chatItemSelector).last().before(r)},scrollBottomChat:function(e){return e.find(this.chatItemsSelector).animate({scrollTop:e.find(this.chatItemsSelector)[0].scrollHeight},1e3)}}),("undefined"!=typeof exports&&null!==exports?exports:this).ChatDOM=t}(jQuery)}.call(this),function(e,t,n,a){"use strict";var o={userid:null},r={online:!1,usersInfo:{},originalTitle:null,playSoundId:null,notification:{sound_new:"affirmative",sound_repeat:"affirmative"},unseenRooms:[],overflowUnseenRooms:[],globalFocusPartnerId:null,roomsCapacity:4,chunkSize:100,blUrl:e.location.origin,maxAttachmentSize:2e7,maxCharacters:350,attachmentType:["image/pjpeg","image/jpeg","image/jpg","image/png","image/x-png","image/bmp","image/x-bmp","image/gif","application/pdf"],timers:{blinkNotificationInterval:1e3,bugRecheckTimes:4,soundNotificationInterval:3e5,sendingTimeout:2e3,unseenTimeout:2e3,scrollTimeout:300,ajaxTimeout:5e3,ajaxRetryTimeout:5e3,ajaxRetryTimes:3,collectUserInfoInterval:1e3},allowChat:0,allowSound:0,showAvatar:0},i=null,s=0;r.blApi=r.blUrl.split("//"),r.blApi[1]="api."+r.blApi[1].replace("www.",""),r.blApi=r.blApi.join("//");var l=null,c=function(e){var t=new Date(e/1e3),n=t.getHours(),a=t.getMinutes(),o="";return 10>a&&(a="0"+a),o+=n+":"+a},u=function(e){var t=["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"],n=["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"],a=new Date(e/1e3),o=t[a.getDay()],r=a.getDate(),i=n[a.getMonth()],s=a.getFullYear(),l="";return l+=o+", "+r+" "+i+" "+s},d=function(e){var t=new Date(e/1e3);return Date.parse(t.toLocaleDateString("en-US"))},m=a.curry(function(e,t,a,o){return n(o).data(e)===t}),p=a.curry(function(e,t,a,o){return n(o).attr(e)===t}),h=a.curry(function(e,t){return t!==e}),f=function(e,t,a){var o=d(t),r=e.find(".chat-room-item-date").filter(m("dateInteger",o));r.length?a&&e.prepend(r):(r=n("<div/>",{"class":"chat-room-item-date",html:'<span class="chat-room-item-date__text"> '+u(t)+"</span>"}).data("dateInteger",o),a?e.prepend(r):e.find(".chat-room-item").last().before(r))},_=function(e,t,a){var o=e.data("lastDlvrdToPrtnr"),i=e.data("lastSeenByUser"),s=e.data("lastSeenByPrtnr"),l=function(e,t,n,a){var o=a.data("messageServerTime"),i=a.hasClass("chat-room-item--owner"),s=["chat-room-item--unsent","chat-room-item--sent","chat-room-item--delivered","chat-room-item--seen","chat-room-item--new","chat-room-item--old"].join(" ");i?n>=o?a.removeClass(s).addClass("chat-room-item--seen"):e>=o?a.removeClass(s).addClass("chat-room-item--delivered"):a.removeClass(s).addClass("chat-room-item--sent"):t>=o?setTimeout(function(){a.removeClass(s).addClass("chat-room-item--old")},r.timers.unseenTimeout):a.removeClass(s).addClass("chat-room-item--new")};null===a?l(o,i,s,t):t.filter(function(e,t){return n(t).data("messageServerTime")<=a}).each(function(e,t){l(o,i,s,n(t))})},g=function(e){setTimeout(function(){var t=[".chat-room-item--sent",".chat-room-item--delivered",".chat-room-item--seen"].join(", ");e.is(t)||e.addClass("chat-room-item--unsent")},r.timers.sendingTimeout)},v=function(t,n){t!==r.globalFocusPartnerId&&(r.globalFocusPartnerId=t,n&&e.localStorage.setItem("chatDefaults.globalFocusPartnerId",t))},y=function(){r.allowChat=+r.elems.$dockWrapper.hasClass("enable-chat-gui"),e.localStorage.setItem("chatDefaults.allowChat",r.allowChat.toString()),r.allowSound=r.elems.$dockWrapper.data("allow-sound"),e.localStorage.setItem("chatDefaults.allowSound",r.allowSound.toString()),r.showAvatar=r.elems.$dockWrapper.data("show-avatar"),e.localStorage.setItem("chatDefaults.showAvatar",r.showAvatar.toString()),ie(r.elems.$roomsOverflowWrappersRight)},b=function(){r.unseenRooms.length?r.playSoundId||(r.playSoundId=setInterval(function(){I(r.notification.sound_repeat)},r.timers.soundNotificationInterval)):(clearInterval(r.playSoundId),r.playSoundId=null,t.title=r.originalTitle)},w=function(){var e=r.elems.$roomsWrapper.eq(1).find(".chat-room"),t=e.length-r.roomsCapacity,n=r.elems.$roomsOverflowWrappers.hasClass("chat-rooms-overflow-wrapper--open");t=0>=t?0:t,r.elems.$roomsNotifierText.text(t),0===t?(n&&r.elems.$roomsOverflowWrappers.removeClass("chat-rooms-overflow-wrapper--open"),r.elems.$roomsOverflowWrappers.addClass("hidden-elem")):r.elems.$roomsOverflowWrappers.removeClass("hidden-elem")},S=function(){return["("+r.unseenRooms.length+") "+r.originalTitle,"-"+r.unseenRooms.length+"- "+r.originalTitle]},I=function(e){var t=n(".js-audio-"+e)[0];r.allowSound&&t.play()},k=function(e,t){var n=e[0].scrollTop,a=e[0].scrollHeight-e[0].clientHeight,o=100,r=o>a-n;(t||r)&&(e[0].scrollTop=a)},C=function(e){var t=n(e.currentTarget).closest(".chat-room"),a=t.data("partnerId");return a},T=function(e,t){var n=a.filter(h(e));return n(t)},x=function(e){return n.ajax({url:"/online/online?user_ids="+e.join(","),type:"get",dataType:"json",timeout:r.timers.ajaxTimeout}).retry({times:r.timers.ajaxRetryTimes,timeout:r.timers.ajaxRetryTimeout})},D=function(e,t,n){var a;return a=void 0,function(){var o,r,i,s;i=this,o=arguments,s=function(){a=null,n||e.apply(i,o)},r=n&&!a,clearTimeout(a),a=setTimeout(s,t),r&&e.apply(i,o)}},j=function(e,t){var n=Date.now||function(){return(new Date).getTime()},a=void 0,o=void 0,r=void 0,i=null,s=0,l=function(){s=n(),i=null,r=e.apply(a,o),a=o=null};return function(){var c=n(),u=t-(c-s);return a=this,o=arguments,0>=u?(clearTimeout(i),i=null,s=c,r=e.apply(a,o),a=o=null):i||(i=setTimeout(l,u)),r}},R=function(e){var t=function(e,t){var a,o=Object.keys(e)[0],r="n"===e[o];r&&(a=n(".btn-create-room").not(".menu-message__link").filter(p("data-user-id",o)),a.each(function(){n(this).addClass("btn-online").attr("title","Chat Sekarang"),0==n(this).parent(".product-chat").length&&(n(this).contents().last()[0].textContent="Online")}))},o=a.addIndex(a.map);o(t,e.online)},A=function(){var e,o,r,i=t.querySelectorAll(".btn-create-room");if(i.length){e=function(e,t){return n(e).attr("data-user-id")};var s=a.addIndex(a.map);o=a.compose(a.uniq,s(e)),r=o(i),x(r).then(function(e){R(e)})}},O=function(t){var a=n(t.currentTarget),o=a.val(),r=C(t),i=H(r).eq(1),s=i.find(".chat-attach-pending");if(""!==o||0!==s.length){a.val("");var c=e.localStorage.getItem("chatDefaults.p_seller"),u=e.localStorage.getItem("chatDefaults.p_sent");if(c===r&&Boolean(u)){var d=e.localStorage.getItem("chatDefaults.p_name"),m=e.localStorage.getItem("chatDefaults.p_link");o='Barang: <a href="'+m+'">'+d+"</a>\n\n"+o,e.localStorage.removeItem("chatDefaults.p_sent")}s.each(function(e){var t=s.eq(e).data("attachment");l.send_message(r,t)}),s.remove(),o&&l.send_message(r,o)}},E=[],N=function(e){var t={defer:n.Deferred(),u_id:e};return E.push(t),t.defer.promise()},$=function pt(){function e(e,t){return e.u_id<t.u_id?-1:e.u_id>t.u_id?1:0}if(E=n.grep(E,function(e,t){return r.usersInfo[e.u_id]?(e.defer.resolve(r.usersInfo[e.u_id]),!1):!0}),0==E.length)return void setTimeout(pt,r.timers.collectUserInfoInterval);E.sort(e);for(var t=E.length,a=[],o=null,i=0;t>i;i++)o!==E[i].u_id&&(o=E[i].u_id,a.push(o));for(var s=[],l=E,c=0,u=Math.ceil(a.length/r.chunkSize),d=!1,i=0;u>i;i++){var m=a.slice(i*r.chunkSize,(i+1)*r.chunkSize),p=n.ajax({url:"/users/"+m.join()+"/info.json",type:"get",dataType:"json",timeout:r.timers.ajaxTimeout}).retry({times:r.timers.ajaxRetryTimes,timeout:r.timers.ajaxRetryTimeout});p.done(function(e){n.merge(s,e)}).fail(function(){d=!0}).always(function(){if(++c==u){if(!d){s.sort(e),E=[];for(var n=0,o=0;t>o;o++)l[o].u_id!=a[n]&&n++,l[o].defer.resolve(s[n]),r.usersInfo[l[o].u_id]=s[n]}setTimeout(pt,r.timers.collectUserInfoInterval)}})}},U=function(e){return r.usersInfo[e]||N(e)},B=function(){var e=S(),n=e.indexOf(t.title),a=(n+1)%e.length;t.title=e[a]},L=function(e){ut(e,e,null,null,"...",!1)},W=function(e){e?l.on_logged_out(Ke):l.on_logged_out(Fe),l.logout()},M=function(){var e=n(".nav-helper__item--username"),t=e.data("token")||null;o.userid=e.attr("data-user-id")||null,r.allowChat&&null!==o.userid&&null!==t?l.login(o.userid,t):W(!1)},P=function(){var e=r.elems.$roomsOverflowWrappers.hasClass("chat-rooms-overflow-wrapper--open");if(0!==r.unseenRooms.length)return B(),r.elems.$roomsWrapper.find(".chat-room--unread").toggleClass("chat-room--blink"),q(),0===r.overflowUnseenRooms.length||e?void r.elems.$roomsNotifier.removeClass("chat-rooms-notifier--blink"):void r.elems.$roomsNotifier.toggleClass("chat-rooms-notifier--blink")},q=function(){var e=r.elems.$roomsWrapper.find(".chat-room--unread.chat-room--focus");if(e.length&&e.find(".chat-room-items").is(":visible")){var t=e.last().data("partnerId");t===i?s++:(i=t,s=1),s===r.timers.bugRecheckTimes&&l.fix_notif(t)}},H=function(e){return r.elems.$roomsWrapper.find("#chat-room-overflow-"+e+", #chat-room-"+e)},z=function(){var e,t,o,i=r.elems.$roomsWrapper.eq(0).find(".chat-room"),s=r.elems.$roomsWrapper.eq(1).find(".chat-room");i.slice(-1*r.roomsCapacity).addClass("hidden-elem"),i.slice(0,-1*r.roomsCapacity).removeClass("hidden-elem"),s.slice(-1*r.roomsCapacity).removeClass("hidden-elem"),e=s.slice(0,-1*r.roomsCapacity).addClass("hidden-elem"),t=e.filter(".chat-room--unread"),o=function(e,t){return n(t).data("partnerId")};var l=a.addIndex(a.map);r.overflowUnseenRooms=l(o,t)},V=function(){r.elems.$roomsOverflowWrappers.hasClass("chat-rooms-overflow-wrapper--open")?r.elems.$roomsOverflowWrappers.removeClass("chat-rooms-overflow-wrapper--open"):r.elems.$roomsOverflowWrappers.addClass("chat-rooms-overflow-wrapper--open")},F=function(t,n){"1"==e.localStorage.getItem("chatAnalytics.track_reject")&&ChatAnalytics.sendRejectAnalytics(t,n,e.localStorage.getItem("chatAnalytics.notes"))},K=function(e){l.reconnect(0)},J=function(e){var t=C(e);l.close_room(t),e.stopPropagation()},G=function(e){var t=C(e);l.show_room(t),e.stopPropagation()},Y=function(e){var t=C(e);l.hide_room(t),e.stopPropagation()},Q=function(e){(!n(e.target).is("a")&&"click"==e.type||27===e.keyCode&&"keydown"==e.type)&&Y(e)},X=function(e,t){var a=n("<i/>",{"class":e+" "+t||""});return a[0].outerHTML},Z=n("<div/>",{"class":"chat-popup-options__wrapper"}),ee=n("<ul/>",{"class":"chat-popup-options__list-items"}),te=n("<li/>",{"class":"chat-popup-options__item"}),ne=function(e){e.hide(),n(t).off(".Popup")},ae=function(e){var a=(C(e),n(e.currentTarget)),o=r.elems.$roomsOverflowWrappersRight.find(".chat-popup-options__wrapper");o.is(":visible")?ne(o):(o.show(),o.offset({left:a.offset().left-o.outerWidth()+a.outerWidth(),top:a.offset().top-o.outerHeight()+1}),n(t).on("keydown.Popup",function(){ne(o)}).on("click.Popup",function(e){e.target.closest(".chat-popup-options__wrapper")||ne(o)})),e.stopPropagation()},oe=function(e,t){var a=e.find(".chat-popup-options__list-items"),o=e.find(".chat-popup-options__item").first().clone(),r=n("<a/>",t);t.separator&&(r=n("<hr/>")),o.append(r),a.append(o),e.append(a)},re=function(){var t,n,a;e.localStorage?(t="1"==e.localStorage.getItem("chatDefaults.allowSound"),n="1"==e.localStorage.getItem("chatDefaults.allowChat"),a="1"==e.localStorage.getItem("chatDefaults.showAvatar")):(t=r.allowSound,n=r.allowChat,a=r.showAvatar);var o=[{html:X("ion-"+(n?"toggle-filled text--green":"toggle text--gray"),"pull-right icon-chat-settings")+"Chat","class":"btn-toggle-active-chat"},{separator:!0},{html:X("ion-"+(t?"toggle-filled text--green":"toggle text--gray"),"pull-right icon-chat-settings")+"Notifikasi Suara","class":"btn-toggle-sound "+(n?"":"disabled--anchor")},{html:X("ion-"+(a?"toggle-filled text--green":"toggle text--gray"),"pull-right icon-chat-settings")+"Tampilan Avatar","class":"btn-toggle-avatar "+(n?"":"disabled--anchor")}];return o},ie=function(e){var t=re(),n=(e.find(".chat-settings"),e.find(".chat-popup-options__wrapper").length?e.find(".chat-popup-options__wrapper"):Z.clone()),a=ee.clone(),o=te.clone();e.children().length&&e.append(n),n.empty(),a.append(o),n.append(a);for(var r=0;r<t.length;r++)oe(n,t[r]);n.find(".chat-popup-options__item").first().remove()},se=function(){r.allowChat=+!r.allowChat,r.allowChat?(r.elems.$dockWrapper.addClass("enable-chat-gui").removeClass("chat-dock--no-room"),Ce()):(r.elems.$dockWrapper.removeClass("enable-chat-gui").addClass("chat-dock--no-room"),W(!1)),ie(r.elems.$roomsOverflowWrappersRight)},le=function(){n(".js-submit-deactivate-reasons").off("submit.deactivate"),n(".js-submit-deactivate-reasons").on("submit.deactivate",function(e){var t=n(this),a=t.attr("action");n.ajax({type:"post",url:a,data:t.serialize(),success:function(){n.colorbox.close(),de(!1),BLFlash.initByJS("Terima kasih telah berpartisipasi dalam meningkatkan kualitas Bukalapak","notice")}}),e.preventDefault()})},ce=function(){var e=n(".js-field-radio__has-other").find('input[type="radio"]');e.off("change.feedback"),e.on("change.feedback",function(){var e=n(".js-field-radio__has-other").find('input[type="radio"]').val(),t=n(".js-field-radio__other").find("textarea:enabled"),a=!Boolean(e);t.length&&(a=!Boolean(t.val())),n(this).closest("form").find('input[type="submit"]').attr("disabled",a)})},ue=function(){n(".js-field-radio__has-other").find('input[type="radio"]:checked').prop("checked",!1).trigger("change"),n(".js-field-radio__other").find("input, textarea").val(""),n.colorbox({inline:!0,href:n(".js-chat-deactivate-popup"),width:600}),BLCommonForm.optionHasOther("radio"),ce(),le(),n.colorbox.resize()},de=function(t){var a=+t||+!r.allowChat;n.ajax({type:"PATCH",dataType:"json",url:"/users/"+o.userid,data:{user:{real_time_chat:a}}}).done(function(t){e.localStorage.setItem("chatDefaults.allowChat",a.toString()),se()}).error(function(e){console.log("error on chat active setting")})},me=function(e){r.allowChat?ue():de(),e.preventDefault()},pe=function(){r.allowSound=+!r.allowSound,ie(r.elems.$roomsOverflowWrappersRight)},he=function(t){n.ajax({type:"PATCH",dataType:"json",url:"/users/"+o.userid,data:{user:{allow_sound:+!r.allowSound}}}).done(function(t){e.localStorage.setItem("chatDefaults.allowSound",(+!r.allowSound).toString()),pe()}).error(function(e){console.log("error on notification sound setting")}),t.preventDefault()},fe=function(){r.showAvatar=+!r.showAvatar,ie(r.elems.$roomsOverflowWrappersRight),r.showAvatar?r.elems.$roomsWrapper.find(".chat-room--open").removeClass("chat-room--no-avatar"):r.elems.$roomsWrapper.find(".chat-room--open").addClass("chat-room--no-avatar")},_e=function(t){n.ajax({type:"PATCH",dataType:"json",url:"/users/"+o.userid,data:{user:{show_avatar:+!r.showAvatar}}}).done(function(t){e.localStorage.setItem("chatDefaults.showAvatar",(+!r.showAvatar).toString()),fe()}).error(function(e){console.log("error on avatar setting")}),t.preventDefault()},ge=function(e){var n;"Range"!==t.getSelection().type&&(n=C(e),et(n))},ve=function(e){var t=C(e),n=H(t).eq(1);Le(n,t)},ye=function(e){var t,a=n(e.currentTarget),o=a.data("partnerId"),r=a.find(".chat-room-items");v(o,!0),r.is(":visible")&&(t=r.find(".chat-room-item--new").last(),t.length&&l.set_last_seen_by_user(o,t.data("messageServerTime"))),a.addClass("chat-room--focus")},be=function(e){var t;0===e.currentTarget.scrollTop&&(t=C(e),l.previousmessages(t))},we=function(e){var t,o=n(e.currentTarget),i=o.find(".chat-room-item-date").get(),s=function(e){var t=n(e);return{position:t.position().top,text:t.text()}},l=function(e){return e.position<0},c=a.prop("position"),u=function(e,t){return e>t},d=function(e){return function(t,n){if(n&&n.length>0){for(var a,o=0,r=n[o],i=t(r);++o<n.length;)a=t(n[o]),e(a,i)&&(i=a,r=n[o]);return r}}},m=a.curry(d(u)),p=a.addIndex(a.map),h=a.compose(m(c),a.filter(l),p(s)),f=h(i);if(f){t=o.find(".chat-room-item-date--float"),t.html(f.text),o.addClass("chat-room-items--scroll"),clearTimeout(o.data("removeScrollId"));var _=setTimeout(function(){o.removeClass("chat-room-items--scroll")},r.timers.scrollTimeout);o.data("removeScrollId",_)}},Se=function(e,t){var a=e.currentTarget,o=n(a),r=a.scrollTop,i=o.height(),s=o.get(0).scrollHeight;(r===s-i&&0>t||0===r&&t>0)&&e.preventDefault()},Ie=function(e){var o=function(e){if(0==t.querySelectorAll(".js-audio-"+e).length){var n=t.createElement("audio");return n.className="js-audio-"+e,n.type="sounds/mpeg",n.src="/sounds/"+e+".mp3",n}},r=a.map(o)(e);n("body").append(r)},ke=function(e){n(".dropdown-menu").off("click.logout"),e&&n(".dropdown-menu").on("click.logout",".btn-logout-bl",function(e){return W(!0),e.preventDefault(),!1})},Ce=function(e){a.contains(t.title,S())||(r.originalTitle=t.title),"undefined"==typeof e&&(e=!1),e&&y(),b(),M()},Te=function(e){switch(e.key){case"chatDefaults.allowSound":pe();break;case"chatDefaults.allowChat":se();break;case"chatDefaults.showAvatar":fe();break;case"chatDefaults.globalFocusPartnerId":var t;t="null"===e.newValue?null:e.newValue,v(t,!1);break;case"chatDefaults.p_name":var a=n(".chat-room--open"),o=n(".chat-room--open").data("partnerId");Le(a,o)}},xe=function(){v(null,!0)},De=function(e){var t=n(e.currentTarget);t.removeClass("chat-room--focus"),v(null,!0)},je=j(O,1e3),Re=function(e){if(r.online){var t=C(e),a=H(t).eq(1),o=n(e.currentTarget);13===e.keyCode?(e.preventDefault(),ChatAnalytics.sendByChatRoom(a),je(e),o.trigger("autosize.resize")):l.typing(t)}else e.preventDefault()},Ae=function(e){var t=Boolean(e.find(".is-uploading").length);e.find(".chat-room-input").attr("disabled",t).focus()},Oe=function(t,a){var o=r.blApi+"/v2/chat_attachments.json",i=(new XMLHttpRequest,new FormData);i.append("file",a);var s=filterXSS(a.name),l=n("<div />",{"class":"chat-attach-pending is-uploading"}),c=n("<div />",{"class":"chat-attach-pending__inner"}),u=n("<div />",{"class":"chat-attach-pending__text-outer"}),d=n("<div />",{"class":"chat-attach-pending__text-inner"}),m=n("<a />",{"class":"chat-attach-pending__text",html:s,title:s}),p=n("<div />",{"class":"chat-attach-pending__action"}),h=n("<span />",{"class":"chat-attach-pending__close js-chat-attach-delete",html:"&times;",title:"hapus"}),f=n("<span />",{"class":"chat-attach-pending__loading"});l.append(c.append(u.append(d.append(m))).append(p.append(f).append(h))),n.ajax({context:l,crossDomain:!0,dataType:"json",type:"POST",url:o,data:i,processData:!1,contentType:!1,beforeSend:function(){t.find(".chat-attach-pending__wrapper").append(l),Ae(t)},success:function(e){"OK"==e.status?(n(this).removeClass("is-uploading"),n(this).data("attachment",e.url),Ae(t)):BLFlash.initByJS(e.message,"alert")},xhr:function(){var t=new e.XMLHttpRequest,a=n(this.context[0]).find(".chat-attach-pending__loading");return t.upload.addEventListener("progress",function(e){if(e.lengthComputable){var t=parseInt(e.loaded/e.total*100,10);a.html(t+"%")}},!1),t}})},Ee=function(e){var t=n(e.target).closest(".chat-attach-pending");t.remove()},Ne=function(e){for(var t=C(e),a=H(t).eq(1),o=a.find(".input-chat-attachment"),i=o[0].files,s=0;s<i.length;s++)-1==r.attachmentType.indexOf(i[s].type)?BLFlash.initByJS("Format file tidak diizinkan","alert"):i[s].size>r.maxAttachmentSize?BLFlash.initByJS("Ukuran file tidak boleh lebih dari 20 MB","alert"):Oe(a,i[s]);n(e.target).val("")},$e=function(e){var t=H(C(e)).eq(1);t.find(".input-chat-attachment").trigger("click")},Ue=function(e){var t=H(C(e)).eq(1),a=parseInt(localStorage.getItem("chatDefaults.p_link").split("/").pop().split("-")[0],36),o=localStorage.getItem("chatDefaults.p_name");n.ajax({type:"json",method:"get",url:"/products/"+a+"/get_product",success:function(e){var n=Be(a,o,e.stock);t.find(".chat-product__wrapper").remove(),n.insertAfter(t.find(".chat-room-flyout__header"))}})},Be=function(e,t,a){var o=n("<form />",{method:"POST",action:"/cart/carts/add_product?express_checkout=true","class":"chat-product__wrapper"}),r=n("<div />",{"class":"js-qty-input"}),i=n("<span />",{"class":"btn btn--decrease btn--gray btn--small js-qty-input__btn-dec",html:"-",title:"stok: "+a}),s=n("<span />",{"class":"btn btn--increase btn--gray btn--small js-qty-input__btn-inc",html:"+",title:"stok: "+a}),l=n("<input />",{"class":"item-quantity js-qty-input__field",id:"item_quantity",type:"text",name:"item[quantity]","data-max-value":a,title:"stok: "+a,value:1}),c=n("<span />",{"class":"product-quantity-text",html:"Jumlah"});r.append(c).append(i).append(l).append(s).jsQtyInput();var u=n("<input />",{type:"hidden",name:"item[product_id]",value:e}),d=n("<button />",{"class":"btn btn--red btn--small btn-submit-buy-chat",html:"Ok",title:"Beli "+t,type:"submit"}),m=n("<div />",{"class":"chat-product__column"});return o.append(u).append(n.BLUtils.renderInputCsrf()).append(m.clone().append(r)).append(m.clone().append(d)).on("submit",function(){ga("send","event","chat","chat/buy")})},Le=function(t,a){if(t.find(".chat-product__wrapper").remove(),Boolean(e.localStorage.getItem("chatDefaults.p_name"))&&a==e.localStorage.getItem("chatDefaults.p_seller")){var o=(e.localStorage.getItem("chatDefaults.p_seller"),e.localStorage.getItem("chatDefaults.p_name")),r=e.localStorage.getItem("chatDefaults.p_link"),i=n("<div />",{"class":"chat-product__wrapper"}),s=n("<div />",{"class":"chat-product__column"}),l=n("<div />",{"class":"chat-product__text-inner"}),c=n("<a />",{html:o,href:r,title:"Lihat "+o}),u=n("<button />",{"class":"btn btn--small btn--red js-buy-chat-trigger",html:"Beli"});i.append(s.clone().append(l.append(c))).append(s.clone().append(u)),i.insertAfter(t.find(".chat-room-flyout__header"))}},We=function(a){var o;n(a.currentTarget).closest(".js-dropdown-menu").length>0&&n(t).trigger("click.bl.dropdown.data-api"),o=n(a.currentTarget).attr("data-user-id"),n(a.currentTarget).attr("p_url")&&(e.localStorage.setItem("chatDefaults.p_seller",o),e.localStorage.setItem("chatDefaults.p_name",n(a.currentTarget).attr("p_name")),e.localStorage.setItem("chatDefaults.p_link",r.blUrl+n(a.currentTarget).attr("p_url")),e.localStorage.setItem("chatDefaults.p_sent","1")),l.create_room(o)},Me=function(t){if(r.online){var a=n(".nav-helper__item--username").data("token")?!0:!1,i=n(t.target).attr("data-user-id"),s=n(t.currentTarget).data("viewedFrom"),l=n(t.currentTarget).data("notes"),c=n(t.currentTarget).data("trackReject");e.localStorage.setItem("chatAnalytics.viewed_from",s),e.localStorage.setItem("chatAnalytics.notes",l),e.localStorage.setItem("chatAnalytics.track_reject",c),(o.userid===i||r.allowChat&&o.userid!==i)&&(t.preventDefault(),t.stopPropagation()),r.allowChat&&o.userid!==i&&a&&We(t)}},Pe=function(e){r.online=e,n(".chat-dock").toggleClass("chat-disconnected",!e)},qe=function(e,t){-1===t.toUpperCase().indexOf("HEARTBEAT")&&console.log(e.toUpperCase()+" "+t.replace(new RegExp("},{","g"),"},\n	{")+"\n")},He=function(){var e=n(".nav-helper__item--username").attr("data-user-id")||null;e&&(n.when(U(e)).then(function(e){}),Ie(["affirmative"]),Pe(!0),ke(!0))},ze=function(){qe("socket","opened")},Ve=function(){qe("socket","closed"),Pe(!1),ke(!1)},Fe=function(){r.usersInfo={},r.unseenRooms=[],b(),r.overflowUnseenRooms=[],r.elems.$roomsWrapper.empty(),w(),Pe(!1),ke(!1)},Ke=function(){Fe(),location.href="/logout"},Je=function(e,t){de(!1);var a=n("<div />"),o=n("<h2 />",{html:"Aktivasi Chat Dibatalkan","class":"chat-popup__activation-header"}),r=n("<p />",{html:"Mohon maaf kamu belum bisa mengaktifkan fitur Bukalapak Chat karena terlalu banyak pesan ("+e+" pesan) yang belum terbaca."}),i=n("<p />",{html:"Silakan coba aktifkan kembali fitur Bukalapak Chat setelah membaca pesan yang belum terbaca."}),s=n("<form />",{method:"post",action:"/messages/toggle"}),l=n("<input />",{type:"hidden",name:"inbox_id[]"}),c=n("<input />",{type:"hidden",name:"toggle_action",value:"read"}),u=n("<input />",{type:"submit","class":"btn btn--medium btn--red pull-right",value:"Set Dibaca Untuk Semua Pesan"});s.append(n.BLUtils.renderInputCsrf()).append(c).append(u),t.forEach(function(e){s.prepend(l.clone().val(e))}),a.append(o).append(n("<hr />",{"class":"hr--compact"})).append(r).append(i).append(s),s.submit(function(e){var t=n(this).serializeArray(),a=n(this);n.ajax({type:"patch",url:a.attr("action"),data:t,beforeSend:function(){n.colorbox.close()},success:function(e){"authorize denied"==e.status?location.href=e.redirect:de(!0)}}),e.preventDefault()}),n.colorbox({href:a,width:"480px",inline:!0})},Ge=function(e,t,a){var o={partnerId:e,roomCreationTime:t,lastDlvrdToUser:0,lastDlvrdToPrtnr:0,lastSeenByUser:0,lastSeenByPrtnr:0,numUnseenByUser:0,numUnseenByPrtnr:0},i=n("<div/>",{id:"chat-room-overflow-"+parseInt(e,10),"class":"chat-room chat-room--overflow",tabindex:1}).data(o),s=n("<div/>",{id:"chat-room-"+parseInt(e,10),"class":"chat-room","data-partner-id":parseInt(e,10),tabindex:1}).data(o),l=n("<div/>",{"class":"chat-room-flyout"}),c=n("<div/>",{"class":"chat-room-flyout__header chat-room-flyout__inner"}),u=n("<div/>",{"class":"chat-room-textwrapper"}),d=n("<div/>",{"class":"chat-room-action"}),m=n("<div/>",{"class":"chat-room-flyout__body chat-room-flyout__inner"}),p=n("<div/>",{"class":"chat-room-flyout__footer chat-room-flyout__inner"}),h=n("<a/>",{"class":"chat-room-name",html:"loading.."}),f=n("<span/>",{"class":"js-toggle-room-status chat-room-status"}),_=n("<i />",{"class":"icon-chat icon-admin icon-badge-online ion-checkmark-round",title:"Bukalapak Team - Offline"}),g=n("<i/>",{"class":"icon-chat icon-admin icon-badge-typing ion-more"}),v=n("<i/>",{"class":"icon-chat icon-chat-online ion-chatbubble"}),y=n("<i/>",{"class":"icon-chat icon-typing icon-chat-typing ion-chatbubble-working"}),b=n("<span/>",{"class":"js-toggle-room-notification"}),S=n("<i/>",{"class":"icon-chat ion-close"}),I=n("<a/>",{"class":"btn-close-flyout js-icon-tooltip btn-icon",title:"Close"}),k=n("<i/>",{"class":"icon-chat ion-minus"}),C=n("<a/>",{"class":"btn-hide-flyout js-icon-tooltip btn-icon",title:"Minimize"}),T=n("<a/>",{"class":"btn-room-flyout__options js-icon-tooltip btn-icon",title:"Options"}),x=n("<div/>",{"class":"chat-room-tab"}),D=n("<div/>",{"class":"chat-room-tab__inner"}),j=n("<div/>",{"class":"chat-room-textwrapper"}),R=n("<div/>",{"class":"chat-room-action"}),A=n("<span/>",{"class":"chat-room-name",html:"loading.."}),O=n("<span/>",{"class":"js-toggle-room-status chat-room-status"}),E=n("<span/>",{"class":"js-toggle-room-notification"}),N=n("<a/>",{"class":"btn-close-tab js-icon-tooltip btn-icon-close btn-icon",title:"Close"}),$=n("<i/>",{"class":"icon-chat ion-chevron-up"}),B=n("<a/>",{"class":"btn-show-tab js-icon-tooltip btn-icon",title:"Maximize"}),W=n("<div/>",{"class":"chat-room-items",style:"height: 230px;"}),M=n("<div/>",{"class":"chat-room-item-date chat-room-item-date--float"}),P=n("<div/>",{"class":"chat-room-input-wrapper display-table-full"}),q=n("<div/>",{"class":"chat-attach-pending__wrapper"}),H=n("<textarea/>",{"class":"chat-room-input js-char-counter--tobe-counted stylish-scroll",placeholder:"Ketik pesan...","data-max-chars":r.maxCharacters,"data-allow-enter":!0}),z=n("<div/>",{"class":"js-char-counter chat-counter"}),V=n("<span/>",{"class":"js-char-counter--display chat-counter__number",html:0}),F=n("<span/>",{"class":"chat-counter__text",html:V[0].outerHTML+" / "+r.maxCharacters+" karakter"}),K=n("<button/>",{"class":"btn btn-transparent--red btn-chat-attachment"}),J=n("<input />",{type:"file",name:"files[]",multiple:"multiple","class":"hidden input-chat-attachment",accept:".jpeg, .jpg, .png, .bmp, .gif, .pdf"}),G=n("<i/>",{"class":"icon-attachment ion-icon ion-android-attach"}),Y=n("<div />",{"class":"display-table-cell"}),Q=n("<div />",{"class":"chat-disconnected__message-box"}),Z=n("<a />",{"class":"chat-disconnected__message",html:"Koneksi terputus. Coba lagi&hellip;"});Q.append(Z),I.append(S),T.append(X("ion-gear-a")),C.append(k),d.append(C).append(I),N.append(S.clone()),B.append($),R.append(B).append(N),f.append(v).append(y).append(_).append(g),u.append(f).append(b).append(h),O.append(v.clone()).append(y.clone()).append(_.clone()).append(g.clone()),j.append(O).append(E).append(A),c.append(d).append(u),D.append(R).append(j),W.append(M),m.append(W).append(Q),K.append(G),z.append(F),P.append(Y.clone().addClass("js-has-hint").append(H).append(z)).append(Y.clone().append(K).append(J)),p.append(P).append(q),l.append(c).append(m).append(p),x.append(D);var ee=x.clone(!0);ee.find(".btn-show-tab").remove(),i.append(ee),s.append(l).append(x),r.elems.$roomsWrapper.eq(0).prepend(i),r.elems.$roomsWrapper.eq(1).prepend(s),w(),r.elems.$dockWrapper.removeClass("chat-dock--no-room"),n.when(U(e)).then(function(e){s.add(i).find(".chat-room-name").attr("title",e.name).html(e.name),h.attr("href","/"+e.username),e.is_admin&&(s.addClass("chat-room-admin"),i.addClass("chat-room-admin"))}),s.add(i).find(".js-icon-tooltip").tooltipster({delay:800,speed:0,timer:0,theme:"tooltip-theme"}),Qe(e,t),L(e)},Ye=function(t){var n=H(t);F(n,"closed"),n.remove(),w(),z(),r.elems.$roomsWrapper.is(":empty")?r.elems.$dockWrapper.addClass("chat-dock--no-room"):r.elems.$dockWrapper.removeClass("chat-dock--no-room"),n.hasClass("chat-room--unread")&&(r.unseenRooms=T(t,r.unseenRooms),b(),r.overflowUnseenRooms=T(t,r.overflowUnseenRooms)),e.localStorage.removeItem("chatAnalytics.viewed_from"),e.localStorage.removeItem("chatAnalytics.notes"),e.localStorage.removeItem("chatAnalytics.track_reject")},Qe=function(e,t){var a,o=H(e).eq(0),i=H(e).eq(1),s=r.elems.$roomsWrapper.eq(0).find(".chat-room"),l=r.elems.$roomsWrapper.eq(1).find(".chat-room"),c=l.index(i);i.add(o).data("roomCreationTime",t),a=l.filter(function(e,a){return n(a).data("roomCreationTime")<=t}).length,a!==c&&(s.eq(a-1).after(o),l.eq(a-1).after(i),z())},Xe=function(e){var t=H(e).eq(1),n=t.find(".chat-room-items"),a=t.find(".chat-room-input");n.find(".chat-room-item");n.on("scroll",D(be,500)).on("scroll",j(we,250)).on("mousewheel",Se),a.autosize({append:!1}),MaxChars.init(),CharCounter.init(),t.is(":visible")||l.recreate_room(e),t.addClass("chat-room--open "+(+r.showAvatar?"":"chat-room--no-avatar")),k(n,!0),a.trigger("focus"),0===n.scrollTop()&&l.previousmessages(e)},Ze=function(t){var n=H(t),a=n.find(".chat-room-items"),o=n.find(".chat-room-input");F(n,"minimized"),a.off("scroll").off("mousewheel"),o.trigger("autosize.destroy"),t==e.localStorage.getItem("chatDefaults.p_seller")&&(e.localStorage.removeItem("chatDefaults.p_seller"),e.localStorage.removeItem("chatDefaults.p_name"),e.localStorage.removeItem("chatDefaults.p_link"),n.find(".chat-product__wrapper").remove()),n.removeClass("chat-room--open").trigger("focusout"),e.localStorage.removeItem("chatAnalytics.viewed_from"),e.localStorage.removeItem("chatAnalytics.notes"),e.localStorage.removeItem("chatAnalytics.track_reject")},et=function(e){var t=H(e),n=t.find(".chat-room-input");n.trigger("focus")},tt=function(e,t){var n=H(e);n.addClass("chat-room--online"),n.eq(0).hasClass("chat-room-admin")?n.find(".icon-chat-online").attr("title","Online!"):n.find(".icon-badge-online").attr("title","Bukalapak Team - Online!")},nt=function(e){var t=H(e);t.removeClass("chat-room--online").find(".chat-room-flyout__header, .chat-room-tab").attr("title","");
},at=function(e,t){var n=H(e);n.data("lastDlvrdToUser",t)},ot=function(e,t){var n=H(e),a=n.find(".chat-room-items"),o=a.find(".chat-room-item--sent");n.data("lastDlvrdToPrtnr",t),_(n,o,t)},rt=function(e,t){var n=H(e),a=n.find(".chat-room-items"),o=a.find(".chat-room-item--new");n.data("lastSeenByUser",t),_(n,o,t)},it=function(e,t){var n=H(e),a=n.find(".chat-room-items"),o=a.find(".chat-room-item--delivered");n.data("lastSeenByPrtnr",t),_(n,o,t)},st=function(e,t){var n=H(e),a=n.data("numUnseenByUser"),o=n.find(".js-toggle-room-notification");n.data("numUnseenByUser",t),0===t?(n.removeClass("chat-room--blink chat-room--unread"),o.removeClass("chat-room-notification").html(""),a>0&&(r.unseenRooms=T(e,r.unseenRooms),b(),r.overflowUnseenRooms=T(e,r.overflowUnseenRooms))):(n.addClass("chat-room--unread"),o.addClass("chat-room-notification").html(t),0===a&&(r.unseenRooms.push(e),b(),n.eq(1).is(":visible")||r.overflowUnseenRooms.push(e)))},lt=function(e,t){var n=H(e);n.data("numUnseenByPrtnr",t)},ct=function(e,t,n){var a=H(e),o=a.find(".chat-room-items"),r=o.find(".chat-room-item").filter(m("messageClientTime",t)),i=r.find(".chat-room-item__message__time");r.data("messageServerTime",n),_(a,r,null),i.html(c(n))},ut=function(e,t,a,o,i,s){var u=H(e),d=u.find(".chat-room-items"),p=null!==o,h=d.find(".chat-room-item");if(i=filterXSS(i,{whiteList:{p:["style"],a:["href","target"],img:["src","alt","width","style"],br:[],ol:[],li:[],b:[],i:[],div:["style"]}}),p){var v=h.filter(m("messageServerTime",o));if(v.length){var y=v.find(".chat-room-item__message__body");return void y.html(i)}}var b=t!==e,w=a||o,S=null===w,C=n("<div/>",{"class":"chat-room-item"+(b?" chat-room-item--owner":"")+(S?" chat-room-item--typing":"")}).data({messageClientTime:a,messageServerTime:o}),T=n("<div/>",{"class":"chat-room-item__message"}),x=n("<div/>",{"class":"chat-room-item__message__body",html:i}),D=n("<div/>",{"class":"chat-room-item__message__time",html:S?" ":c(w)+" WIB"}),j=n("<span/>",{"class":"chat-room-item__message__status"});if(T.append(x).append(D).append(j),!b){var R="/images/default_avatar/thumb/default.jpg",A=n("<div/>",{"class":"chat-room-item__image"}),O=n("<img/>",{"class":"chat-room-item__image__avatar",src:R});A.append(O),C.append(A),n.when(U(t)).then(function(e){O.attr("src",e.avatar)})}if(C.append(T),S)d.append(C);else{var E=u.hasClass("chat-room--focus"),N=d.is(":visible"),$=t===r.globalFocusPartnerId;if(!b&&E&&N&&l.set_last_seen_by_user(e,w),s){var B,L=d[0].scrollTop,W=d[0].scrollHeight,M=W-L;d.prepend(C),f(d,w,!0),B=d[0].scrollHeight,d[0].scrollTop=B-M}else f(d,w,!1),h.last().before(C),k(d,!0);s||b||$||I(r.notification.sound_new),p?_(u,C,null):g(C)}},dt=function(e){var t=H(e),n=t.find(".chat-room-items");t.addClass("chat-room--typing"),k(n,!1)},mt=function(e){var t=H(e);t.removeClass("chat-room--typing")};n(t).on("click",".btn-create-room",Me).ready(function(){if(null===l){r.elems={$dockWrapper:n(".chat-dock"),$chatSettings:n(".chat-settings"),$roomsOverflowWrappers:n(".chat-rooms-overflow-wrapper"),$roomsOverflowWrappersRight:n(".chat-rooms-overflow-wrapper--right"),$roomsWrapper:n(".chat-rooms-wrapper"),$roomsNotifier:n(".chat-rooms-notifier"),$roomsNotifierText:n(".chat-rooms-notifier__text")},r.elems.$dockWrapper.on("focusin",".chat-room",ye).on("focusout",".chat-room",De).on("focus",".chat-room-input",ve).on("click",".chat-room-flyout__header",Q).on("click",".btn-close-flyout",J).on("click",".btn-hide-flyout",Y).on("click",".chat-room-tab",G).on("click",".btn-close-tab",J).on("click",".btn-show-tab",G).on("click",".chat-room-items",ge).on("keypress",".chat-room-input",Re).on("keydown",".chat-room-input",Q).on("click",".js-buy-chat-trigger",Ue).on("click",".btn-chat-attachment",$e).on("change",".input-chat-attachment",Ne).on("click",".js-chat-attach-delete",Ee).on("click",".btn-toggle-active-chat",me).on("click",".btn-toggle-avatar:not(.disabled--anchor)",_e).on("click",".btn-toggle-sound:not(.disabled--anchor)",he).on("click",".chat-disconnected__message",K),r.elems.$roomsNotifier.on("click",V),r.elems.$chatSettings.on("click",ae);var t=location.origin;-1!==t.indexOf("bukalapak.com")&&(t=t.replace("://www","://c"+Math.floor(20*Math.random())));var a=t+"/palaver";l=e.create_palaver({servers_url:a,transports:"websocket",reconnect_interval_min:3e3,reconnect_interval_max:6e3,reconnect_limit:200,synchronize_interval:1e3,retyping_interval:3e3,typing_timeout:5e3,heartbeat_interval:3e3,heartbeat_timeout:15e3}),l.on_logged_in(He).on_logged_out(Fe).on_socket_opened(ze).on_socket_closed(Ve).on_too_many(Je).on_room_created(Ge).on_room_closed(Ye).on_room_reordered(Qe).on_room_shown(Xe).on_room_hidden(Ze).on_room_focused(et).on_room_online(tt).on_room_offline(nt).on_last_dlvrd_to_user_changed(at).on_last_dlvrd_to_prtnr_changed(ot).on_last_seen_by_user_changed(rt).on_last_seen_by_prtnr_changed(it).on_num_unseen_by_user_changed(st).on_num_unseen_by_prtnr_changed(lt).on_message_updated(ct).on_message_added(ut).on_start_typing(dt).on_stop_typing(mt),setInterval(P,r.timers.blinkNotificationInterval),setTimeout($,r.timers.collectUserInfoInterval),e.Palaver=l}r.elems.$dockWrapper.length&&Ce(!0),A()}),e.addEventListener("storage",Te,!1),e.onbeforeunload=xe}(window,document,window.$,window.R),function(){$(function(){var e,t;return e=new ChatPopup({userId:parseInt($("body").data("currentUser"),36),partnerId:$(".user-display .btn-create-room").data("userId"),triggerTimeSeconds:60,pageToActive:".products-c.show-a"}),t=new ChatPopup({userId:parseInt($("body").data("currentUser"),36),partnerId:$(".user-display .btn-create-room").data("userId"),triggerTimeSeconds:30,pageToActive:".users-c.show-a"})})}.call(this),function(){window.ChatAnalytics=function(){return{sendRejectAnalytics:function(e,t,n){var a,o,r,i;return r=parseInt($("body").data("current-user"),36),o=e.data("partnerId"),i=e.data("viewed_from"),a={user_id:r,partner_id:o,viewed_from:i,reject_by:t,notes:n},$.post("/messages/"+r+"/chat_analytics",{chat_analytics:$.BLUtils.compactObject(a,!0)})},sendData:function(e,t,n,a,o){var r;return r={partner_id:t,viewed_from:n,message:a,notes:o},$.post("/messages/"+e+"/chat_analytics",{chat_analytics:$.BLUtils.compactObject(r,!0)})},sendByChatRoom:function(e){var t,n,a,o,r;return r=window.localStorage.getItem("chatAnalytics.viewed_from"),n=window.localStorage.getItem("chatAnalytics.notes"),o=$(".nav-helper__item--username").data("userId"),a=e.data("partnerId"),t=e.find(".chat-room-input").val(),window.localStorage.getItem("chatAnalytics.viewed_from")&&this.sendData(o,a,r,t,n),window.localStorage.removeItem("chatAnalytics.viewed_from"),window.localStorage.removeItem("chatAnalytics.notes"),window.localStorage.removeItem("chatAnalytics.track_reject")}}}()}.call(this),function(){!function(e,t){var n;return n=function(e){this.intervalHours=e.intervalHours||12,this.pageToActive=e.pageToActive||"undefined-page-selector",this.triggerTimeSeconds=e.triggerTimeSeconds||30,this.userId=e.userId,this.partnerId=e.partnerId,this.chatRoomItemClass="chat-room-item--by-system chat-room-popupchat",this.chatRoomSelector=".chat-room:not(.chat-room--overflow)",this.chatRoomOpenSelector=".chat-room--open",this.enabledChatSelector=".chat-dock.enable-chat-gui",this.buttonUserDisplaySelector=".user-display .btn-create-room",this.popupMessageSelector=".chat-room-popupchat",t.localStorage.removeItem(""+this.eventNamespace),t.localStorage.removeItem(this.eventNamespace+".userId"),t.localStorage.removeItem(this.eventNamespace+".partnerId"),this.userId&&this.partnerId&&n.prototype.init.call(this)},n.prototype=e.extend(ChatDOM.prototype,{eventNamespace:"ChatPopup",secondsMark:0,timeout:null,updateStorage:function(e){switch(e.key){case this.eventNamespace:return this.createMessage()}},createMessage:function(){var n,a,o;return n=this,o=t.localStorage.getItem(this.eventNamespace+".userId"),a=t.localStorage.getItem(this.eventNamespace+".partnerId"),e.when(this.getInfoDeferred([o,a])).done(function(e){var t,a,o,r;return r=e[0],o=e[1],t=n.getChatRoom(o.u_id).eq(1),a="Hai <strong>"+r.name+"</strong>. Selamat datang di lapak <a href='/"+o.username+"'>"+o.name+"</a>.<br />Apakah ada yang bisa kami bantu?",t.find(n.popupMessageSelector).length?void 0:(n.addMessage(t,a,o.avatar,{chatRoomItemClass:n.chatRoomItemClass}),setTimeout(function(){return n.scrollBottomChat(t)},0))})},validateCondition:function(){var n,a,o,r,i,s,l;for(l=!0,r=[],o=[this.isInPage,this.isNoOpenRoom,this.isNotMuchRoom,this.isAllOnlineDeferred,this.isNotChatRecentlyDeferred],i=0,s=o.length;s>i;i++)a=o[i],-1===a.name.indexOf("Deferred")?l=l&&a.call(this):r.push(a.call(this));return l?(n=this,e.when.apply(this,r).done(function(){var a,o,r,i;for(o=0,r=arguments.length;r>o;o++)i=arguments[o],l=l&&i;return l?(a=e(document.body).find(n.buttonUserDisplaySelector),a.trigger("click"),t.localStorage.setItem("chatAnalytics.notes",n.eventNamespace.toLowerCase()),t.localStorage.setItem("chatAnalytics.track_reject","1"),t.localStorage.setItem(n.eventNamespace,Date.now()),t.localStorage.setItem(n.eventNamespace+".userId",n.userId),t.localStorage.setItem(n.eventNamespace+".partnerId",n.partnerId),n.createMessage()):void 0})):void 0},isNoOpenRoom:function(){return 0===e(this.chatRoomOpenSelector).length},isNotMuchRoom:function(){return e(this.chatRoomSelector).length<30},isInPage:function(){return e(this.pageToActive).length>0&&this.userId!==this.partnerId},isAllOnlineDeferred:function(){var t;return t=e.Deferred(),e.ajax({context:this,dataType:"json",delay:5e3,type:"GET",url:"/online/online?user_ids="+this.partnerId,success:function(n){var a,o;return o=e(this.enabledChatSelector).length>0,a="n"===n.online[0][this.partnerId],t.resolve(a&&o)}}),t.promise()},isNotChatRecentlyDeferred:function(){var t;return t=e.Deferred(),e.ajax({context:this,dataType:"json",type:"GET",url:"/messages/"+this.userId+"/get_info?partner_id="+this.partnerId,success:function(n){var a,o;return o=!0,n.last_message_at&&(a=e.BLUtils.diffDateInHour(new Date,new Date(n.last_message_at)),o=a>=this.intervalHours),t.resolve(o)}}),t.promise()},startTicking:function(){var n;return this.stopTicking(),n=this,this.secondsMark<this.triggerTimeSeconds?this.timeout=setTimeout(function(){return n.secondsMark++,n.startTicking()},1e3):(this.validateCondition(),e(t).off("focus."+this.eventNamespace),e(t).off("blur."+this.eventNamespace))},stopTicking:function(){return clearTimeout(this.timeout)},init:function(){return document.hidden||this.startTicking(),e(t).on("focus."+this.eventNamespace,this.startTicking.bind(this)),e(t).on("blur."+this.eventNamespace,this.stopTicking.bind(this)),t.addEventListener("storage",this.updateStorage.bind(this),!1)}}),("undefined"!=typeof exports&&null!==exports?exports:this).ChatPopup=n}(jQuery,window)}.call(this),function(e,t){e.create_palaver=function(e){var n,a=null,o=null,r=null,i=null,s=null,l=!1,c=null,u={},d=null,m=[],p={last_dlvrd_to_user:[],last_dlvrd_to_prtnr:[],last_seen_by_user:[],last_seen_by_prtnr:[],num_unseen_by_user:[],num_unseen_by_prtnr:[]},h=-1,f=[],_=!1,g=!1,v={last_dlvrd_to_user:!1,last_dlvrd_to_prtnr:!1,last_seen_by_user:!1,last_seen_by_prtnr:!1,num_unseen_by_user:!1,num_unseen_by_prtnr:!1},y=!0,b=!0,w=e,S=0,I=null,k=[],C=function(e,t){return n},T=function(e){return C=e,n},x=function(){return n},D=function(e){return x=e,n},j=function(){return n},R=function(e){return j=e,n},A=function(){return n},O=function(e){return A=e,n},E=function(){return n},N=function(e){return E=e,n},$=function(e,t){return n},U=function(e){return $=e,n},B=function(e,t){return n},L=function(e){return B=e,n},W=function(e){return n},M=function(e){return W=e,n},P=function(e,t){return n},q=function(e){return P=e,n},H=function(e){return n},z=function(e){return H=e,n},V=function(e){return n},F=function(e){return V=e,n},K=function(e){return n},J=function(e){return K=e,n},G=function(e){return n},Y=function(e){return G=e,n},Q=function(e){return n},X=function(e){return Q=e,n},Z=function(e,t){return n},ee=function(e){return Z=e,n},te=function(e,t){return n},ne=function(e){return te=e,n},ae=function(e,t){return n},oe=function(e){return ae=e,n},re=function(e,t){return n},ie=function(e){return re=e,n},se=function(e,t){return n},le=function(e){return se=e,n},ce=function(e,t){return n},ue=function(e){return ce=e,n},de=function(e,t,a){return n},me=function(e){return de=e,n},pe=function(e,t,a,o,r,i){return n},he=function(e){return pe=e,n},fe=function(e){return n},_e=function(e){return fe=e,n},ge=function(e){return n},ve=function(e){return ge=e,n},ye=function(e){var t="; "+document.cookie,n=t.split("; "+e+"=");return 2===n.length?n.pop().split(";").shift():null},be=function(){return 1e3*(new Date).getTime()},we=function(e,t){if(t)e.cl_ts=be(),f.push(e);else{if(!l&&"LOGIN"!==e.cmd&&"HEARTBEATCLIENT"!==e.cmd)return;if(!y)return void C("connection","not reliable, just do not send anything");var n="["+JSON.stringify(e)+"]";C("send",n),r.send(n)}},Se=function(){C("action","tell server about heartbeatclient");var e={cmd:"HEARTBEATCLIENT",data:{}};we(e,!1);var t=be();t-i>1e3*w.heartbeat_timeout&&r.close()},Ie=function(){if(f.length>0){if(_=!0,!l)return;if(!y)return void C("connection","not reliable, just do not send anything");var e=t.map(f,function(e){return JSON.stringify(e)}),n="["+e.join(",")+"]";C("flush",n),r.send(n)}else _=!1},ke=function(e){f=t.grep(f,function(t,n){return t.cl_ts>e})},Ce=function(){C("action","tell server about ackserver ["+h+"]");var e={cmd:"ACKSERVER",data:{last_acksv:h}};we(e,!1)},Te=function(e){u={},d=null,m=[],p={last_dlvrd_to_user:[],last_dlvrd_to_prtnr:[],last_seen_by_user:[],last_seen_by_prtnr:[],num_unseen_by_user:[],num_unseen_by_prtnr:[]},h=-1,e&&(f=[],_=!1),g=!1,v={last_dlvrd_to_user:!1,last_dlvrd_to_prtnr:!1,last_seen_by_user:!1,last_seen_by_prtnr:!1,num_unseen_by_user:!1,num_unseen_by_prtnr:!1},E()},xe=function(e){var t=ye("browser_id");if(null!==e&&e===t){C("action","tell server that this socket has logout");var n={cmd:"ACKLOGOUTSERVER",data:{}};we(n,!0),Ie()}(null===e||e===t)&&(a=null,o=null,l=!1,c=null,Te(!0))},De=function(e,t){"OK"===e?(null!==c&&c!==t&&(C("action","reset instant messager"),Te(!1)),l=!0,c=t,x(),C("login info","["+a+"] successfully logged in with rsocket id ["+c+"]")):(C("login info","["+a+"] unsuccessfully logged in"),xe(null))},je=function(e){C("action","tell server about ackroomserver ["+e+"]");var t={cmd:"ACKROOMSERVER",data:{last_rm_sv_ts:e}};we(t,!1)},Re=function(){if(m.length>0){if(g=!0,!y)return void C("connection","not reliable, just do not send anything");C("action","tell server about roomclient");var e={cmd:"ROOMCLIENT",data:{rms_stt_mod:m}};we(e,!1)}else g=!1},Ae=function(e,n,a,o){m=t.grep(m,function(t,n){return t.partner_id!==e}),m.push({partner_id:e,rm_cr_ts:n,rm_up_ts:a,value:o}),Re()},Oe=function(e){var t=u[e].first_message_client_time;C("action","request previous messages with ["+e+"] before ["+t+"]");var n={cmd:"PREVIOUSMESSAGES",data:{prtnr_id:e,frst_msg_cl_ts:t}};we(n,!1)},Ee=function(e,t,n){if(t?(d=e,H(e)):(d=null,V(e)),n){C("action","tell server that room with ["+e+"] has been "+(t?"shown":"hidden"));var a=u[e].room_creation_time,o=be();Ae(e,a,o,"created"),o=be(),Ae("shown_room_user_id",null,o,t?e:null)}},Ne=function(e,t){e===d&&u[e]&&Ee(e,!1,t)},$e=function(e,t){return e===d?void K(e):(null!==d&&Ne(d,!1),void(u[e]&&Ee(e,!0,t)))},Ue=function(e){$e(e,!0)},Be=function(e,t,n){if(e!==a){if(u[e])return void(t?Ue(e):u[e].room_creation_time!==n&&(u[e].room_creation_time=n,P(e,n)));var o=n,r=null,i=null,s=null,l={last_dlvrd_to_user:0,last_dlvrd_to_prtnr:0,last_seen_by_user:0,last_seen_by_prtnr:0,num_unseen_by_user:0,num_unseen_by_prtnr:0};u[e]={room_creation_time:o,first_message_client_time:r,last_typing_client_time:i,id_typing:s,array_value:l},B(e,o),t&&(C("action","tell server that room with ["+e+"] has been created"),Ae(e,o,o,"created"),Ue(e))}},Le=function(e,t){u[e].room_creation_time=t,P(e,t),C("action","tell server that room with ["+e+"] has been recreated"),Ae(e,t,t,"created"),Ue(e)},We=function(e,t){if(void 0!==u[e]){var n=u[e].room_creation_time;delete u[e],W(e);var a;d===e&&(d=null,t&&(a=be(),Ae("shown_room_user_id",null,a,null))),t&&(C("action","tell server that room with ["+e+"] has been closed"),a=be(),Ae(e,n,a,"closed"))}},Me=function(e,t){$(e,t)},Pe=function(e,n){je(e),n=t.grep(n,function(e){var n=t.grep(m,function(t){return t.partner_id===e.partner_id&&t.rm_up_ts>=e.rm_up_ts});return 0===n.length});var a,o,r,i,s="",l=function(e){return e.partner_id!==o.partner_id};for(a=0;a<n.length;++a)o=n[a],m=t.grep(m,l),r=o.partner_id,i=o.value,"shown_room_user_id"===r?s=i:"created"===i?Be(r,!1,o.rm_cr_ts):We(r,!1);""!==s&&(null!==s?$e(s,!1):null!==d&&Ne(d,!1))},qe=function(e){m=t.grep(m,function(t,n){return t.rm_up_ts>e})},He=function(e){C("action","tell server about ackonlineserver ["+e+"]");var t={cmd:"ACKONLINESERVER",data:{last_ol_sv_ts:e}};we(t,!1)},ze=function(e,t){He(e);var n,a,o,r;for(n=0;n<t.length;++n)a=t[n],o=a.partner_id,r=a.is_ol,u[o]&&(r?G(o):Q(o))},Ve=function(e,t){C("action","tell server about ackvalueserver ["+t+"]");var n={cmd:"ACKVALUESERVER",data:{key:e,last_value_sv_ts:t}};we(n,!1)},Fe=function(e){var n=p[e];if(n.length>0){if(v[e]=!0,!y)return void C("connection","not reliable, just do not send anything");C("action","tell server about valueclient related to ["+e+"]");var a=t.map(n,function(e,t){return e.value_up_ts}),o=Math.max.apply(Math,a),r=t.map(n,function(e,t){return{partner_id:e.partner_id,value:e.value}}),i={cmd:"VALUECLIENT",data:{key:e,last_value_up_ts:o,values_mod:r}};we(i,!1)}else v[e]=!1},Ke=function(e,n,a,o){C("action","tell server that ["+e+"] for room ["+n+"] has been changed to ["+o+"]"),p[e]=t.grep(p[e],function(e,t){return e.partner_id!==n}),p[e].push({partner_id:n,value_up_ts:a,value:o}),Fe(e)},Je=function(e,t,n,a){if(void 0!==u[t]&&!(-1!==["last_dlvrd_to_user","last_dlvrd_to_prtnr","last_seen_by_user","last_seen_by_prtnr"].indexOf(e)&&n<=u[t].array_value[e])){if(u[t].array_value[e]=n,a){var o=be();Ke(e,t,o,n)}switch(e){case"last_dlvrd_to_user":Z(t,n);break;case"last_dlvrd_to_prtnr":te(t,n);break;case"last_seen_by_user":ae(t,n);break;case"last_seen_by_prtnr":re(t,n);break;case"num_unseen_by_user":se(t,n);break;case"num_unseen_by_prtnr":ce(t,n)}}},Ge=function(e,n,a){Ve(e,n),-1!==["last_dlvrd_to_user","last_dlvrd_to_prtnr","last_seen_by_user","last_seen_by_prtnr"].indexOf(e)&&(a=t.grep(a,function(n){var a=t.grep(p[e],function(e){return e.partner_id===n.partner_id&&e.value>=n.value});return 0===a.length}));var o,r,i=function(e){return e.partner_id!==r.partner_id};for(o=0;o<a.length;++o)r=a[o],p[e]=t.grep(p[e],i),Je(e,r.partner_id,r.value,!1)},Ye=function(){setTimeout(Ye,w.synchronize_interval),g&&Re(),_&&Ie(),v.last_dlvrd_to_user&&Fe("last_dlvrd_to_user"),v.last_seen_by_user&&Fe("last_seen_by_user")},Qe=function(e,n){p[e]=t.grep(p[e],function(e,t){return e.value_up_ts>n})},Xe=function(e,t){var n=u[e].first_message_client_time;(null===n||n>t)&&(u[e].first_message_client_time=t)},Ze=function(e){var t=u[e].id_typing;null!==t&&(u[e].id_typing=null,clearTimeout(t),ge(e))},et=function(e,t,n,o,r,i,s,l){if(r&&i?(Xe(e,i),de(e,r,i)):r?pe(e,a,r,null,o,!1):(Xe(e,i),pe(e,t,null,i,o,l),a===n&&Je("last_dlvrd_to_user",e,i,!0)),s){C("action","tell server that ["+t+"] send ["+o+"] to ["+n+"]");var c={cmd:"SEND",data:{msg_cl_ts:r,rcvr_id:n,msg:o}};we(c,!0),Ie()}},tt=function(e,t,n,o,r,i){var s;return s=a===n?t:n,void 0===u[s]?void(10>i&&setTimeout(function(){tt(e,t,n,o,r,i+1)},1e3)):(a===n&&Ze(t),void et(s,t,n,o,null,e,!1,r))},nt=function(e,t,n){void 0!==u[t]&&et(t,null,null,null,e,n,!1,!1)},at=function(e){if(u[e]){var t=u[e].id_typing;null===t?fe(e):clearTimeout(t),u[e].id_typing=setTimeout(function(){Ze(e)},w.typing_timeout)}},ot=function(){i=be()},rt=function(){return f},it=function(){return m},st=function(e){return p[e]},lt=function(){r.close()},ct=function(){return r.protocol},ut=function(e,t){if(r.readyState!==SockJS.OPEN)return void setTimeout(function(){ut(e,t)},1e3);if(null===e||null===c){null!==e?C("action","tell server that ["+e+"] want to login"):C("action","tell server that ["+a+"] want to relogin"),a=e||a,o=t||o;var n={cmd:"LOGIN",data:{id:a,token:o,rsock_id:c}};we(n,!1)}},dt=function(e){l||(clearTimeout(I),I=setTimeout(ht,e))},mt=function(){if(null!==c){C("action","tell server that this socket want to logout");var e=ye("browser_id"),t={cmd:"LOGOUTCLIENT",data:{idntt:e}};we(t,!1)}},pt=function(){return t.BLUtils.getRandomInt(w.reconnect_interval_min,w.reconnect_interval_max)},ht=function(){t(".nav-helper__item--username").data("token")&&(r=new SockJS(w.servers_url,null,{transports:w.transports}),r.onopen=function(){S=0,C("connection","open"),j(),null!==c&&ut(null,null),i=be(),s=setInterval(Se,w.heartbeat_interval)},r.onclose=function(){S+=1,C("connection","close"),l=!1,A(),S<=w.reconnect_limit&&dt(pt()),i=null,null!==s&&(clearInterval(s),s=null)},r.onmessage=function(e){if(!b)return void C("connection","not reliable, just pretend not receive anything");C("receive",e.data);var n=JSON.parse(e.data),a=h,o=n[n.length-1].sv_ts;void 0!==o&&(o>h&&(h=o),Ce()),n=t.grep(n,function(e,t){return void 0===e.sv_ts||e.sv_ts>a});var r,i,s,c,u,d,m,p,f,_,g,v,y,w,S,I,k,T,x,D,j,R,A,O;for(r=0;r<n.length;++r)if(i=n[r],s=i.data,l||"ACKLOGIN"===i.cmd||"HEARTBEATSERVER"===i.cmd)if("ACKLOGIN"===i.cmd)c=s.status,u=s.rsock_id,De(c,u);else if("ACKSEND"===i.cmd)d=s.msg_cl_ts,m=s.rcvr_id,p=s.msg_sv_ts,nt(d,m,p);else if("DELIVER"===i.cmd)p=s.msg_sv_ts,f=s.sndr_id,_=s.rcvr_id,g=s.msg,v=s.is_prpnd,tt(p,f,_,g,v,0);else if("ACKCLIENT"===i.cmd)y=s.last_ackcl,ke(y);else if("ACKROOMCLIENT"===i.cmd)w=s.last_rm_up_ts,qe(w);else if("ACKVALUECLIENT"===i.cmd)S=s.key,I=s.last_value_up_ts,Qe(S,I);else if("TOOMANY"===i.cmd)unread_rooms_count=s.unrd_rm_c,unread_partner_ids=s.unrd_prtnr_ids,Me(unread_rooms_count,unread_partner_ids);else if("ROOMSERVER"===i.cmd)k=s.last_rm_sv_ts,T=s.rms_stt,Pe(k,T);else if("ONLINESERVER"===i.cmd)x=s.last_ol_sv_ts,D=s.ols_stt,ze(x,D);else if("VALUESERVER"===i.cmd)S=s.key,j=s.last_value_sv_ts,R=s.values,Ge(S,j,R);else if("TYPINGSERVER"===i.cmd)A=s.prtnr_id,at(A);else if("LOGOUTSERVER"===i.cmd)O=s.idntt,xe(O);else{if("HEARTBEATSERVER"===i.cmd)return void ot();C("error","unhandled cmd")}Ie()})},ft=function(e){y=e},_t=function(e){b=e},gt=function(e){var t=be();Be(e,!0,t)},vt=function(e){var t=be();Le(e,t)},yt=function(e){We(e,!0)},bt=function(e){e=e||d,Ne(e,!0)},wt=function(e,t){Je("last_seen_by_user",e,t,!0)},St=function(e,t){var n=be();u[e].last_typing_client_time=null,et(e,a,e,t,n,null,!0,!1)},It=function(e){var t=be();u[e].last_typing_client_time=null,et(e,a,e,"buzz",t,null,!0,!1)},kt=function(e){var t=be(),n=u[e].last_typing_client_time;if(!(null!==n&&t-n<1e3*w.retyping_interval)){u[e].last_typing_client_time=t,C("action","tell server about typing at room related to ["+e+"]");var a={cmd:"TYPINGCLIENT",data:{prtnr_id:e}};we(a,!1)}},Ct=function(e){if(-1===k.indexOf(e)){k.push(e);var t={cmd:"FIX_NOTIF",data:{prtnr_id:e}};we(t,!1)}};return ht(),Ye(),n={q:rt,rsm:it,vm:st,cs:lt,gp:ct,login:ut,logout:mt,reconnect:dt,set_can_send:ft,set_can_receive:_t,create_room:gt,close_room:yt,show_room:Ue,hide_room:bt,set_last_seen_by_user:wt,recreate_room:vt,send_message:St,send_buzz:It,previousmessages:Oe,typing:kt,fix_notif:Ct,on_log:T,on_logged_in:D,on_socket_opened:R,on_socket_closed:O,on_logged_out:N,on_too_many:U,on_room_created:L,on_room_closed:M,on_room_reordered:q,on_room_shown:z,on_room_hidden:F,on_room_focused:J,on_room_online:Y,on_room_offline:X,on_last_dlvrd_to_user_changed:ee,on_last_dlvrd_to_prtnr_changed:ne,on_last_seen_by_user_changed:oe,on_last_seen_by_prtnr_changed:ie,on_num_unseen_by_user_changed:le,on_num_unseen_by_prtnr_changed:ue,on_message_updated:me,on_message_added:he,on_start_typing:_e,on_stop_typing:ve}}}(window,jQuery),function(){}.call(this);